# Results

```{r}
library(readxl)
library(dplyr)
library(ggplot2)
library(cowplot)
library(tidyr)
library(GGally)
library(ggrepel)
library(viridis)
data <- read_excel("/Users/qingwenliu/Desktop/Edav/data.xlsx")
```

## Impact of Air Pollution and Water Pollution on Average Life Expectancy

```{r}
Avg_life_expectancy <- data |>
  filter(indicator_name == "Life expectancy at birth (years)") |>
  group_by(setting) |>
  summarise(Average_life_expectancy = mean(estimate, na.rm = TRUE))

Ambient_air_pollution <- data |>
  filter(indicator_name == "Ambient air pollution attributable death rate (per 100 000 population)") |>
  group_by(setting) |>
  summarise(ambient_life_expectancy = mean(estimate, na.rm = TRUE))
Household_air_pollution <- data |>
  filter(indicator_name == "Household air pollution attributable death rate (per 100 000 population)") |>
  group_by(setting) |>
  summarise(household_life_expectancy = mean(estimate, na.rm = TRUE))

Environment_data_1 <- merge(Avg_life_expectancy, Ambient_air_pollution, by = "setting")
Environment_data <-merge(Household_air_pollution,Environment_data_1, by = "setting")
```

```{r}
Ambient_death_rate <- data |>
  filter(indicator_name == "Ambient air pollution attributable death rate (per 100 000 population)") |>
  group_by(setting) |>
  summarise(ambient_rate = mean(estimate, na.rm = TRUE))

Household_death_rate <- data |>
  filter(indicator_name == "Household air pollution attributable death rate (per 100 000 population)") |>
  group_by(setting) |>
  summarise(household_rate = mean(estimate, na.rm = TRUE))

merged_1 <- merge(Ambient_death_rate, Household_death_rate, by = "setting")

Death_rate <- merge(Avg_life_expectancy, merged_1,by ="setting") |>
  pivot_longer(cols = c(household_rate, ambient_rate), names_to = "types", values_to = "percent")

ggplot(Death_rate,aes(x = percent, y = Average_life_expectancy)) +
  geom_smooth(method = "lm") +
  facet_wrap(~types) +
  geom_point(size = 2, alpha = 0.5) +  
  labs(title = "Relationship between Life Expectancy and Air Pollution", x = "Death Rate Due to Air Pollution(per 100,000 population)", y = "Life expectancy") +
  theme_minimal(base_size=12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5), # Center-align title
    plot.subtitle = element_text(hjust = 0.5) # Center-align subtitle
  )
```

The scatter plots illustrate the relationship between two types of air pollution and life expectancy. In the right plot, there is a strong negative association between household air pollution rates and life expectancy. As household air pollution increases, life expectancy declines significantly, underscoring the harmful impact of indoor air pollution on public health. On the left, the relationship between ambient air pollution and life expectancy appears slightly positive. This unexpected trend may be influenced by confounding variables such as economic development, healthcare access, or regional disparities in pollution exposure and mitigation efforts, suggesting that the relationship between ambient air pollution and life expectancy is not straightforward and warrants further investigation.

```{r}
open_defecation <- data |>
  filter(indicator_name =="Population practicing open defecation (%)") |>
  group_by(setting) |>
  summarise(open_defecation= mean(estimate, na.rm = TRUE))

basic_drinking_water <- data |>
  filter(indicator_name == "Population using at least basic drinking-water services (%)") |>
  group_by(setting) |>
  summarise(basic_drinking = mean(estimate, na.rm = TRUE))

basic_sanitation <- data |>
  filter(indicator_name == "Population using at least basic sanitation services (%)") |>
  group_by(setting) |>
  summarise(basic_sanitation = mean(estimate, na.rm = TRUE))

managed_drinking_water <-data |>
  filter(indicator_name == "Population using safely managed drinking-water services (%)") |>
  group_by(setting) |>
  summarise(managed_drinking = mean(estimate, na.rm = TRUE))

managed_sanitation_water <-data |>
  filter(indicator_name == "Population using safely managed sanitation services (%)") |>
  group_by(setting) |>
  summarise(managed_sanitation = mean(estimate, na.rm = TRUE))

basic_handwashing_facilitation <- data|>
  filter(indicator_name =="Population using safely managed sanitation services (%)") |>
  group_by(setting) |>
  summarise(handwashing = mean(estimate, na.rm = TRUE))

#Merge datasets
Environment_data_1 <- merge(basic_drinking_water, basic_sanitation, by = "setting")
Environment_data_2 <-merge(managed_drinking_water,Environment_data_1, by = "setting")
Environment_data_3 <-merge(open_defecation,Environment_data_2, by = "setting")
Environment_data_4 <- merge(basic_handwashing_facilitation,Environment_data_3, by = "setting")
Environment_data_5 <- merge(managed_sanitation_water, Environment_data_4,by = "setting")
Water_pollution <- merge(Avg_life_expectancy, Environment_data_5,by = "setting")

# Identify top 5 and bottom 5 countries by average life expectancy
top_bottom_10 <- Water_pollution |>
  arrange(desc(Average_life_expectancy)) |>
  mutate(rank = row_number()) %>%
  mutate(category = case_when(
    rank <= 9 ~ "Top 9",
    rank > n() - 9 ~ "Bottom 9",
    TRUE ~ NA_character_
  )) %>%
  filter(!is.na(category))%>%  # Keep only Top 5 and Bottom 5
  mutate(category = factor(category, levels = c("Top 9", "Bottom 9")))
top_10 <- top_bottom_10 |>
  filter(category == "Top 9")
bottom_10 <- top_bottom_10 |>
  filter(category == "Bottom 9")
top_10 |>
  pivot_longer(cols = c(managed_sanitation,handwashing,open_defecation,managed_drinking,basic_drinking,basic_sanitation), names_to = "Types", values_to = "Percent") |>
  ggplot(aes(x = Types, y = Percent, fill = Types)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ setting+rank) +
  scale_fill_viridis_d()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.subtitle = element_text(hjust = 0.5),
        plot.title = element_text(face = "bold", hjust = 0.5)) +
  labs(title = "Countries with Top 9 Life Expectancy")
bottom_10 |>
  pivot_longer(cols = c(managed_sanitation,
                        handwashing,
                        open_defecation,
                        managed_drinking,
                        basic_drinking,basic_sanitation), 
               names_to = "Types", values_to = "Percent") |>
  ggplot(aes(x = Types, y = Percent, fill = Types)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ setting+rank) +
  scale_fill_viridis_d() +
  labs(title = "Countries with Bottom 9 Life Expectancy")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.subtitle = element_text(hjust = 0.5),
        plot.title = element_text(face = "bold", hjust = 0.5))
```

The bar plots vividly illustrate disparities in water and sanitation services between countries with the highest and lowest average life expectancy. The x-axis represents various types of services, including basic and managed drinking water and sanitation, handwashing facilities, and open defecation rates. In the top 9 countries with the highest life expectancy, the population overwhelmingly relies on basic and managed services, with over 75% accessibility in most categories. Handwashing facilities are similarly widespread. However, in the bottom 9 countries, usage rates for managed services plummet, particularly for sanitation and drinking water. Open defecation, almost non-existent in high-life-expectancy nations, surges to around 20% in low-life-expectancy regions. These stark contrasts highlight the essential role of water, sanitation, and hygiene (WASH) services in promoting public health and improving life expectancy, underscoring the critical need for infrastructure investments in underserved areas.

## Influence of Personal Behavior of Smoking and Drinking on Life Expectancy

```{r}
Daily_intake <- data |>
  filter(indicator_name == "Alcohol, average daily intake among drinkers (grams)")
life_expectancy_date <- data |>
  filter(indicator_name == "Life expectancy at birth (years)") |>
  group_by(date) |>
  summarise(Average_life_expectancy = mean(estimate, na.rm = TRUE))
Heavy_drinking <- Daily_intake |>
  group_by(date) |>
  summarise(alcohol_intake = mean(mean(estimate, na.rm = TRUE)))
life_alcohol <- merge(life_expectancy_date,Heavy_drinking,by ="date")

ggplot(life_alcohol) +
  geom_line(aes(x = date, y = Average_life_expectancy, color = "Life Expectancy"), size = 1) +
  geom_line(aes(x = date, y = alcohol_intake, color = "Alcohol Consumption"), size = 1) +
  scale_y_continuous(
    name = "Average Life Expectancy (Years)",
    sec.axis = sec_axis(~ ., name = "Alcohol Consumption (Grams)", labels = function(x) paste0(x))
  ) +
  scale_color_viridis_d(option = "D") + 
  labs(
    title = "Average Life Expectancy and Alcohol Consumption Over Time",
    x = "Year"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    legend.title = element_blank(),
    axis.title.y.left = element_text(color = "black"),
    axis.title.y.right = element_text(color = "black"),
    legend.position = "bottom"
  )
  
```

Turning to lifestyle factors, the multiple time series graph explores alcohol intake and average life expectancy from 2000 to 2020. Alcohol consumption shows a slight decline, especially after 2010, while life expectancy exhibits a steady upward trend, suggesting overall health improvements. The trends hint at a complex relationship: while alcohol intake slightly decreased, life expectancyâ€™s growth slowed around the same period. This suggests that other factors, beyond alcohol consumption alone, may also shape life expectancy trends. 


```{r}
Alcohol_country<- Daily_intake |>
  group_by(setting) |>
  summarise(alcohol_intake = mean(mean(estimate, na.rm = TRUE)))
Alcohol <- merge(Alcohol_country,Avg_life_expectancy, by="setting")
ggplot(Alcohol, aes(x = alcohol_intake, y = Average_life_expectancy)) +
  geom_point(alpha = 0.5) +  # Scatter points
  geom_smooth(method = "loess", se = TRUE) + 
  scale_fill_viridis_d()+# Linear trend line
  labs(title = "Average Life Expectancy and Alcohol Consumption By Countries",
       x = "Alcohol Consumption (grams)",
       y = "Life Expectancy") +
  theme_minimal(base_size=12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5), # Center-align title
    plot.subtitle = element_text(hjust = 0.5), # Center-align subtitle
    legend.title = element_blank()
  )
```

Further examining the connection between alcohol and life expectancy, the dot plot highlights a nonlinear relationship across 182 countries. Life expectancy increases with moderate alcohol consumption, peaking around 20 grams daily. Beyond this level, it plateaus and then declines as alcohol consumption rises. Notably, the variability in life expectancy at both very low and very high levels of alcohol consumption suggests that additional factors, such as socioeconomic conditions or health policies, may contribute to the observed trends. Moderate consumption appears to associate with slightly higher life expectancy, while excessive drinking clearly correlates with reduced longevity. The observed increase in life expectancy among individuals consuming alcohol below 20% may be partially attributed to economic and income-related factors. Compared to non-drinkers, one possibility is that moderate drinkers may have greater financial means, allowing them to afford better healthcare and maintain a healthier lifestyle overall. From a medical perspective, moderate alcohol consumption, particularly red wine, has been linked to a reduced risk of cardiovascular disease. This aligns with the trend observed in the data, suggesting that moderate drinking, in combination with other socio-economic advantages, may contribute positively to longevity.

```{r}
cigarette_date <- data |>
  filter(indicator_name == "Estimate of current cigarette smoking prevalence (%)") |>
  group_by(date) |>
  summarise(cigarette_prevalence = mean(mean(estimate, na.rm = TRUE)))
tobacco_use_date <- data |>
  filter(indicator_name == "Estimate of current tobacco use prevalence (%)") |>
  group_by(date) |>
  summarise(tobacco_use_prevalence = mean(mean(estimate, na.rm = TRUE)))
Smoking_date <- merge(tobacco_use_date,cigarette_date,by ="date")
life_smoke_date <- merge(Smoking_date,life_expectancy_date,by="date") 

smoke_date <- life_smoke_date |>
  pivot_longer(cols = c(tobacco_use_prevalence, cigarette_prevalence),names_to = "types",values_to = "value")

ggplot(life_smoke_date) +
  geom_line(aes(x = date, y = Average_life_expectancy, color = "Life Expectancy"), size = 1) +
  geom_line(aes(x = date, y = tobacco_use_prevalence, color = "Tobacco Use Prevalence(%)"), size = 1) +
  geom_line(aes(x = date, y = cigarette_prevalence, color = "Cigarette Prevalence(%)"), size = 1) +
  scale_y_continuous(
    name = "Average Life Expectancy (Years)",
    sec.axis = sec_axis(~ ., name = "Prevalence", labels = function(x) paste0(x,"%"))
  ) +
  scale_color_viridis_d(option = "D") + 
  labs(
    title = "Average Life Expectancy and Alcohol Consumption Over Time",
    x = "Year"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    legend.title = element_blank(),
    axis.title.y.left = element_text(color = "black"),
    axis.title.y.right = element_text(color = "black"),
    legend.position = "bottom"
  )
```

Shifting focus to smoking prevalence, another multiple time series graph highlights trends in life expectancy and cigarette use and tobacco use prevalence from 2000 to 2020. Life expectancy consistently increases, albeit with a slight plateau around 2019-2020, whereas cigarette and tobacco use prevalence steadily declines. This inverse relationship suggests that decreasing cigarette and tobacco use prevalence, likely driven by public health campaigns and regulatory measures, may contribute to longer lifespans.

```{r}
cigarette_country <- data |>
  filter(indicator_name == "Estimate of current cigarette smoking prevalence (%)") |>
  group_by(setting) |>
  summarise(cigarette_prevalence = mean(mean(estimate, na.rm = TRUE)))
tobacco_use_country <- data |>
  filter(indicator_name == "Estimate of current tobacco use prevalence (%)") |>
  group_by(setting) |>
  summarise(tobacco_use_prevalence = mean(mean(estimate, na.rm = TRUE)))

Smoking_country <- merge(tobacco_use_country,cigarette_country,by ="setting")
life_smoke_country <- merge(Smoking_country,Avg_life_expectancy,by="setting") 
smoke_country <- life_smoke_country |>
  pivot_longer(cols = c(tobacco_use_prevalence, cigarette_prevalence),names_to = "types",values_to = "value")
ggplot(smoke_country, aes(x = value, y = Average_life_expectancy)) +
  geom_point(alpha = 0.6) +  # Scatter points
  geom_smooth(method = "loess", se = TRUE) + 
  scale_fill_viridis_d()+# Linear trend line
  labs(title = "Life Expectancy and Smoking Prevalence By Countries",
       x = "Smoking Prevalence(%)",
       y = "Life Expectancy") +
  theme_minimal(base_size=12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5), # Center-align title
    plot.subtitle = element_text(hjust = 0.5), # Center-align subtitle
    legend.title = element_blank()
  )
```

The dot plot examining smoking prevalence and life expectancy reveals a nuanced pattern. Initially, life expectancy rises with smoking prevalence up to around 20-25%, potentially reflecting better healthcare and socioeconomic conditions in moderately smoking populations. However, beyond this point, higher smoking prevalence leads to a clear decline in life expectancy, emphasizing the negative health impacts of smoking. This trend illustrates how, while moderate smoking prevalence might mask its adverse effects in certain contexts, high smoking rates unequivocally shorten lifespans. Similarly, the observed increase in life expectancy among individuals who are smoking below 25% may be partially attributed to economic and income-related factors. Compared to non-smokers, one possibility is that moderate smokers may have greater financial means, allowing them to afford better healthcare and maintain a healthier lifestyle overall. 

## Life Expectancy Trends by World Bank Income Groups

```{r}
# Filter and prepare the dataset
life_expectancy_data <- data |>
  filter(indicator_name == "Life expectancy at birth (years)") |>
  mutate(wbincome2024 = factor(
    wbincome2024, 
    levels = c("High income", "Upper middle income", "Lower middle income", "Low income")
  ))
#write.csv(life_expectancy_data, "life_expectancy_data.csv", row.names = FALSE)
# Calculate average life expectancy for all countries by setting and income group
country_avg_life_expectancy <- life_expectancy_data %>%
  group_by(setting, wbincome2024) %>%
  summarize(average_life_expectancy = mean(estimate, na.rm = TRUE), .groups = "drop")
```

```{r}
# Plot the boxplot
ggplot(
  country_avg_life_expectancy[!is.na(country_avg_life_expectancy$wbincome2024), ], 
  aes(x = wbincome2024, y = average_life_expectancy, fill = wbincome2024)
) +
  geom_boxplot(outlier.size = 1, alpha = 0.8) + # Adjust outlier size and box transparency
  theme_minimal(base_size = 12) + # Slightly larger base font size
  scale_fill_viridis_d() + # Choose a specific viridis color option
  labs(
    title = "Life Expectancy Across Income Levels (2024)",
    subtitle = "A comparative analysis of life expectancy by World Bank income groups",
    x = "World Bank Income Group",
    y = "Life Expectancy (Years)"
  ) +
  theme(
    legend.position = "none", 
    plot.title = element_text(face = "bold", hjust = 0.5), # Center-align title
    plot.subtitle = element_text(hjust = 0.5) # Center-align subtitle
  )
```

The boxplot visualizes life expectancy across countries categorized by World Bank income groups for the year 2024. The income groups include High income, Upper middle income, Lower middle income, and Low income. The chart indicates a clear positive correlation between income levels and life expectancy. High-income countries exhibit the highest median life expectancy, around 80 years, with only one outliers. Upper middle-income countries have a slightly lower median life expectancy, with more noticeable outliers, indicating greater variability in life expectancy within this group. Lower middle-income countries follow, showing a further reduction in median life expectancy and a wider spread of data, reflecting a greater disparity in health outcomes. Finally, low-income countries have the lowest median life expectancy, roughly around 60 years, with a narrower range but significantly lower values overall. On one hand, the stark contrast between high-income and low-income countries, approximately a 20-year difference in median life expectancy, emphasizes the profound impact of economic disparities on health and longevity. On the other hand, the increased spread in middle-income countries highlights the challenges of inequality within nations, even as they experience economic growth. These countries often face uneven development, with urban centers benefiting from resources while rural or marginalized communities lag behind. To improve life expectancy globally, targeted interventions are needed. In low-income countries, efforts should focus on improving access to clean water, sanitation, basic healthcare, and nutrition. For middle-income countries, addressing internal disparities through investments in equitable healthcare and infrastructure is essential.

```{r}
# Identify Top 20 and Bottom 20 countries by average life expectancy
top_bottom_countries <- country_avg_life_expectancy %>%
  arrange(desc(average_life_expectancy)) %>%
  mutate(rank = row_number()) %>%
  mutate(category = case_when(
    rank <= 20 ~ "Top 20",
    rank > n() - 20 ~ "Bottom 20",
    TRUE ~ NA_character_
  )) %>%
  filter(!is.na(category)) %>%  # Keep only Top 20 and Bottom 20 countries
  mutate(category = factor(category, levels = c("Top 20", "Bottom 20")))

# Plot the faceted bar chart
ggplot(top_bottom_countries, aes(x = reorder(setting, -average_life_expectancy), y = average_life_expectancy, fill = wbincome2024)) +
  geom_bar(stat = "identity") +
  theme_minimal(base_size = 12) +
  scale_fill_viridis_d()+
  facet_wrap(~ category, scales = "free_x") +  # Ensure separate x-scales but fixed y-axis
  labs(
    title = "Average Life Expectancy: Top 20 and Bottom 20 Countries",
    x = "Country",
    y = "Average Life Expectancy (Years)",
    fill = "Income Group"
  ) +
  theme(
    axis.text.x = element_text(size = 8, angle = 45, hjust = 1),
    strip.text = element_text(face = "bold"),
    plot.title = element_text(face = "bold", hjust = 0.5),
    panel.spacing = unit(1, "lines")  # Increase spacing between facets for clarity
  )
```

The Top 20 countries, all are classified as High income, demonstrate a direct correlation between economic prosperity and health outcomes. High life expectancy in these countries, consistently above 80 years, reflects advanced healthcare systems, widespread access to preventive care, high educational attainment, and robust public health infrastructure. These nations also benefit from lower rates of preventable diseases, effective management of chronic conditions, and social safety nets that support healthy aging. However, the clustering of high-income countries in this category raises questions about how lower-income nations can bridge this gap, particularly given the evident association between wealth and life expectancy.

The Bottom 20 countries, on the other hand, expose stark disparities. This group includes nations from Low income and Lower middle income categories, with a single representation from the Upper middle income group. Average life expectancy in this group, ranging from 50 to 60 years, is significantly lower than in the Top 20, reflecting the profound influence of socioeconomic factors on health. Challenges such as limited access to healthcare, high rates of infectious diseases, poor sanitation, malnutrition, and insufficient public health investment are likely contributors to these lower outcomes. For example, countries like Lesotho face a unique combination of socioeconomic and health crises, including high rates of HIV/AIDS, which dramatically reduce life expectancy.

The solitary representation of an Upper middle income country in the Bottom 20 warrants special attention. It suggests that income classification alone does not fully explain disparities in life expectancy. Factors such as political instability, corruption, uneven distribution of wealth, or regional health crises could account for this anomaly, indicating the need to go beyond income classifications to fully understand disparities in global health outcomes.

## The Role of Healthcare Personnel in Improving Global Life Expectancy

```{r}
# Read datasets with appropriate skipping of rows for headers
medical_doctors <- read_excel("/Users/qingwenliu/Desktop/Edav/medical_doctors_per10000.xlsx", skip = 2)
nursing_midwifery <- read_excel("/Users/qingwenliu/Desktop/Edav/nursing_midwifery_per10000.xlsx", skip = 2)

# Calculate average medical doctors per 10,000 population by country
country_avg_medical_doctors <- medical_doctors %>%
  group_by(Location) %>%
  summarize(
    average_medical_doctors = mean(as.numeric(Value), na.rm = TRUE),  # Ensure numeric conversion
    .groups = "drop"
  )

# Calculate average nursing and midwifery personnel per 10,000 population by country
country_avg_nursing_midwifery <- nursing_midwifery %>%
  group_by(Location) %>%
  summarize(
    average_nursing_midwifery = mean(as.numeric(Value), na.rm = TRUE),  # Ensure numeric conversion
    .groups = "drop"
  )

# Merge datasets by Location (Country) and Life Expectancy Data
merged_data <- merge(country_avg_medical_doctors, country_avg_nursing_midwifery, by = "Location")
merged_data <- merge(country_avg_life_expectancy, merged_data, by.x = "setting", by.y = "Location")

# Create scatterplot for Life Expectancy vs. Doctors per 10,000
p1 <- ggplot(merged_data, aes(x = average_medical_doctors, y = average_life_expectancy)) +
  geom_point(alpha = 0.7, color = "darkred") +
  geom_smooth(method = "loess", color = "blue", se = TRUE) +
  theme_minimal(base_size = 14) +
  labs(
    title = "Life Expectancy vs. Doctors",
    x = "Number of Doctors per 10,000 Population",
    y = "Life Expectancy (Years)"
  )+
  theme(
    plot.title = element_text(size = 10, face = "bold"),  # Increase title size
    axis.title.x = element_text(size = 9),  # Increase x-axis title size
    axis.title.y = element_text(size = 9),  # Increase y-axis title size
    axis.text.x = element_text(size = 9),  # Increase x-axis label size
    axis.text.y = element_text(size = 9)   # Increase y-axis label size
  )

# Create scatterplot for Life Expectancy vs. Nursing and Midwifery per 10,000
p2 <- ggplot(merged_data, aes(x = average_nursing_midwifery, y = average_life_expectancy)) +
  geom_point(alpha = 0.7, color = "darkgreen") +
  geom_smooth(method = "loess", color = "blue", se = TRUE) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Life Expectancy vs. Nursing and Midwifery",
    x = "Number of Nursing/Midwifery Personnel per 10,000 Population",
    y = "Life Expectancy (Years)"
  )+
  theme(
    plot.title = element_text(size = 10, face = "bold"),  # Increase title size
    axis.title.x = element_text(size = 9),  # Increase x-axis title size
    axis.title.y = element_text(size = 9),  # Increase y-axis title size
    axis.text.x = element_text(size = 9),  # Increase x-axis label size
    axis.text.y = element_text(size = 9)   # Increase y-axis label size
  )

# Combine the two plots into one grid for comparison
plot_grid(p1, p2)
```

The scatterplots illustrate the relationship between life expectancy and the availability of healthcare personnel, specifically doctors and nursing/midwifery personnel, per 10,000 population. In the first plot, a strong positive correlation is observed between the number of doctors and life expectancy at lower doctor-to-population ratios. For countries with fewer than 10 doctors per 10,000 people, life expectancy increases sharply as the availability of doctors rises, reflecting the critical role of medical practitioners in addressing basic healthcare needs and reducing preventable deaths. However, the relationship begins to plateau beyond approximately 20 doctors per 10,000, suggesting diminishing returns in higher-resource settings where additional doctors have a minimal incremental effect on already high life expectancy. The second plot reveals a similar pattern for nursing and midwifery personnel. Countries with low numbers of nursing and midwifery staff exhibit substantial increases in life expectancy as their numbers grow, emphasizing the importance of these personnel in maternal and general healthcare delivery. As with doctors, the relationship flattens at higher ratios, likely due to the saturation of healthcare systems where basic medical needs are already met. These findings underscore the critical role of healthcare personnel in improving life expectancy in underserved regions while highlighting the limits of their impact in more developed settings

## Relationship between Obesity, Income, and Life Expectancy Across Nations
```{r}
# Process health indicator datasets
insufficient_activity_data <- data %>%
  filter(indicator_name == "Insufficient physical activity among adults aged 18+ years (age-standardized) (%)") %>%
  group_by(setting) %>%
  summarize(setting_average = mean(setting_average, na.rm = TRUE), .groups = "drop")

child_obesity_data <- data %>%
  filter(indicator_name == "Obesity prevalence among children and adolescents (crude estimate) (%)") %>%
  group_by(setting) %>%
  summarize(setting_average = mean(setting_average, na.rm = TRUE), .groups = "drop")

BMI_data <- data %>%
  filter(indicator_name == "Obesity prevalence among adults, BMI>=30 (age-standardized) (%)") %>%
  group_by(setting) %>%
  summarize(setting_average = mean(setting_average, na.rm = TRUE), .groups = "drop")

blood_pressure_data <- data %>%
  filter(indicator_name == "Raised blood pressure (SBP>=140 OR DBP>=90) (18+ years) (age-standardized) (%)") %>%
  group_by(setting) %>%
  summarize(setting_average = mean(setting_average, na.rm = TRUE), .groups = "drop")

blood_glucose_data <- data %>%
  filter(indicator_name == "Raised fasting blood glucose (>=7.0 mmol/L) (18+ years) (age-standardized) (%)") %>%
  group_by(setting) %>%
  summarize(setting_average = mean(setting_average, na.rm = TRUE), .groups = "drop")


# Combine datasets into a single table
parallel_data <- child_obesity_data %>% 
  left_join(BMI_data, by = "setting", suffix = c("_child_obesity", "_Adult_BMI")) %>%
  left_join(insufficient_activity_data, by = "setting") %>%
  left_join(blood_pressure_data, by = "setting") %>%
  left_join(blood_glucose_data, by = "setting") %>%
  left_join(country_avg_life_expectancy, by = "setting")

parallel_data <- parallel_data %>%
  rename(
    Child_Obesity = setting_average_child_obesity,
    Adult_BMI = setting_average_Adult_BMI,
    Insufficient_Physical_Inactivity = setting_average.x,
    Raised_Blood_Pressure = setting_average.y,
    Raised_Blood_Glucose = setting_average,
    Life_Expectancy = average_life_expectancy
  )

# Create parallel coordinate plot
ggparcoord(
  data = parallel_data,
  columns = c(2:5, 8),  # Use selected numeric columns for plotting
  groupColumn = 7,      # Group by income group or region
  scale = "uniminmax",  # Normalize data to [0,1]
  title = "Parallel Coordinate Plot of Health Indicators and Life Expectancy",
  alphaLines = 0.3      # Adjust transparency for overlapping lines
) +
  theme_minimal(base_size = 12) +
  scale_color_viridis_d() +
  labs(
    y = "Normalized Scale",
    x = "Health Indicators",
    color = "Income Group"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 9),  # Improve axis text readability
    legend.title = element_text(size = 9, face = "bold"),
    plot.title = element_text(face = "bold"),
    legend.text = element_text(size = 9)
  )
```

The parallel coordinate plot illustrates the relationships between various health indicators (e.g., child obesity, adult BMI, insufficient physical activity, raised blood pressure) and life expectancy, grouped by World Bank income classifications. Each line represents a country, with values normalized to a scale between 0 and 1 for comparability across indicators. The colors distinguish countries based on their income group.

Countries in the High income group (darker lines) often show higher values for child obesity, adult BMI and insufficient physical activity, reflecting lifestyle patterns such as sedentary behavior and high-calorie diets that are more prevalent in wealthier nations. Despite this, these countries maintain relatively high life expectancy, likely due to advanced healthcare systems that manage chronic conditions effectively. In contrast, Low income countries (lighter lines) generally have higher rates of raised blood pressure and child obesity along with lower life expectancy, which may be attributed to limited access to healthcare, poor nutrition, and higher prevalence of untreated health conditions.

## Other factors - suicide and homicide

```{r}
# Process suicide data
suicide_data <- data %>%
  filter(indicator_name %in% c(
    "Crude suicide rates (per 100 000 population) - Female", 
    "Crude suicide rates (per 100 000 population) - Male"
  )) %>%
  group_by(setting, indicator_name) %>%
  summarize(
    setting_average = mean(setting_average, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = indicator_name,
    values_from = setting_average
  )

# Merge suicide data with life expectancy data
merged_data3 <- suicide_data %>%
  left_join(country_avg_life_expectancy, by = "setting")

# Plot male vs female suicide rates, faceted by income group
ggplot(merged_data3[!is.na(merged_data3$wbincome2024), ], 
       aes(
  x = `Crude suicide rates (per 100 000 population) - Female`, 
  y = `Crude suicide rates (per 100 000 population) - Male`
)) +
  geom_point(alpha = 0.4, color = "blue", size = 2) +  # Adjust transparency and size for clarity
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed", size = 1) +  # Add y = x line
  theme_minimal(base_size = 12) +  # Increase base font size for better readability
  labs(
    title = "Comparison of Male and Female Suicide Rates by Income Group",
    x = "Female Suicide Rate (per 100,000)",
    y = "Male Suicide Rate (per 100,000)"
  ) +
  facet_wrap(~ wbincome2024) +  # Allow facets to adjust scales for better visualization
  theme(
    strip.text = element_text(size = 12, face = "bold"),  # Emphasize facet titles
    axis.text = element_text(size = 10),  # Increase axis text size
    axis.title = element_text(size = 12)  # Adjust axis title size
  )
```

```{r}
# Process homicide data
homicide_data <- data %>%
  filter(indicator_name == "Homicide rate (per 100 000 population)") %>%
  group_by(setting, subgroup) %>%
  summarize(
    setting_average = mean(estimate, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = subgroup,
    values_from = setting_average
  )

# Merge homicide data with life expectancy data
merged_data4 <- homicide_data %>%
  left_join(country_avg_life_expectancy, by = "setting")

# Plot male vs female homicide rates, faceted by income group
ggplot(merged_data4[!is.na(merged_data4$wbincome2024), ], 
       aes(x = `Female`, y = `Male`)) +
  geom_point(alpha = 0.4, color = "blue", size = 2) +  # Adjust transparency and size
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed", size = 1) +  # Add y = x line
  theme_minimal(base_size = 12) +  # Increase base font size for better readability
  labs(
    title = "Comparison of Male and Female Homicide Rates by Income Group",
    x = "Female Homicide Rate (per 100,000)",
    y = "Male Homicide Rate (per 100,000)"
  ) +
  facet_wrap(~ wbincome2024) +  # Allow scales to adjust for each facet
  theme(
    strip.text = element_text(size = 12, face = "bold"),  # Emphasize facet titles
    axis.text = element_text(size = 10),  # Adjust axis text size
    axis.title = element_text(size = 12)  # Adjust axis title size
  )
```

Societal challenges are explored in the two graphs, which examine gender disparity in suicide and homicide rates across different income groups, revealing significant patterns influenced by socioeconomic factors. In the first graph, male suicide rates consistently exceed female rates across all income levels, with the gap being particularly pronounced in high-income and upper-middle-income countries. This suggests that while higher-income countries may have better access to mental health resources, societal pressures and mental health challenges disproportionately affect men. In lower-income countries, the disparity narrows slightly, though male rates still dominate, reflecting underlying cultural, societal, and economic factors. The second graph demonstrates a similar pattern for homicide rates, with male rates significantly exceeding female rates in all income groups. This disparity is most severe in upper-middle-income countries, where male homicide rates frequently surpass 60 to 90 per 100,000, likely due to higher levels of systemic violence, instability, and limited law enforcement. However, despite these patterns, the overall mortality due to suicide and homicide is relatively small compared to other causes of death and thus contributes minimally to the observed differences in life expectancy across income groups. This suggests that while suicide and homicide reflect important societal challenges, their direct impact on life expectancy is limited relative to broader health and systemic factors.


## PCA
```{r}
merged_data_1 <- merge(Alcohol_country,Smoking_country,by = "setting")
merged_data_2 <- merge(merged_data_1,Ambient_death_rate,by = "setting" )
merged_data_3 <-merge(merged_data_2,Household_death_rate,by = "setting")
country_avg_nursing_1 <- country_avg_nursing_midwifery |> rename("setting" = "Location")
merged_data_4 <- merge(merged_data_3,country_avg_nursing_1)
country_avg_medical_doctors_1 <- country_avg_medical_doctors |> rename("setting" = "Location")
merged_data_5 <- merge(merged_data_4,country_avg_medical_doctors_1)
blood_pressure_data_1 <- blood_pressure_data |> rename("blood_pressure_avg" = "setting_average")
merged_data_6 <- merge(merged_data_5,blood_pressure_data_1, by = "setting")
insufficient_activity_data <- insufficient_activity_data |> rename("Insufficient_prevalence"="setting_average")
merged_data_7 <- merge(merged_data_6, insufficient_activity_data, by = "setting")
merged_data <- merge(merged_data_7,Environment_data_5 ,by ="setting")
numeric_data <- merged_data[, sapply(merged_data, is.numeric)]
scaled_data <- scale(numeric_data)
pca_result <- prcomp(scaled_data, center = TRUE, scale. = TRUE)
pca_var <- as.data.frame(pca_result$rotation)  # Variable loadings
pca_var$varname <- rownames(pca_var)          # Add variable names

pca_ind <- as.data.frame(pca_result$x)        # Individual scores
pca_ind$obsname <- rownames(pca_ind)          # Add observation names

# Scale variable loadings for better visibility
scaling_factor <- max(abs(pca_ind$PC1), abs(pca_ind$PC2)) / max(abs(pca_var$PC1), abs(pca_var$PC2))
pca_var$PC1 <- pca_var$PC1 * scaling_factor
pca_var$PC2 <- pca_var$PC2 * scaling_factor

# Add colors to variables based on categories (assign colors manually if needed)
pca_var$color <- factor(pca_var$varname)  # Create a factor to assign unique colors

# Calculate explained variance percentages
explained_variance <- summary(pca_result)$importance[2, ] * 100
xlab <- paste0("PC1 (", round(explained_variance[1], 1), "% explained variance)")
ylab <- paste0("PC2 (", round(explained_variance[2], 1), "% explained variance)")

# Create the PCA biplot with differentiated colors and side text labels
ggplot() +
  geom_point(data = pca_ind, aes(x = PC1, y = PC2), color = "black") +
  geom_segment(data = pca_var,
               aes(x = 0, y = 0, xend = PC1, yend = PC2),
               arrow = arrow(length = unit(0.2, "cm")),
               color = viridis::viridis(n = nrow(pca_var))) +
  geom_text_repel(data = pca_var,
                 aes(x = PC1, y = PC2, label = rownames(pca_var)),
                 size = 3,
                 force = 1,
                 max.overlaps = Inf) +
  labs(title = "PCA Biplot", x = xlab, y = ylab) +
  theme_minimal(base_size = 12) +
  theme(axis.title = element_text(size = 12), plot.title = element_text(hjust = 0.5, size = 14))
```

In the PCA plot, PC1 (46.6% explained variance) accounts for the majority of the variance in the data. Variables highly correlated with PC1 have the strongest influence on the overall variation. PC2 (14.4% explained variance) accounts for a smaller portion of the variation but captures the second most significant pattern in the data. Variables such as ambient rate, tobacco use prevalence, and cigarette prevalence are positively correlated and point in the same direction, indicating that they are strongly related. Similarly, basic drinking, basic sanitation services, managed drinking, and handwashing facilities are positively correlated and also cluster together, suggesting a shared influence. Key contributors to PC1 include household rate, ambient rate, and tobacco use prevalence, which have strong impacts on overall variation. For PC2, variables like managed drinking and managed sanitation contribute positively, representing the second major pattern in the data. When it comes to life expectancy, variables such as managed sanitation services, managed drinking services, and basic sanitation services have positive influences, indicating that improvements in water and sanitation infrastructure are associated with substantial gains in life expectancy. Conversely, variables like average blood pressure,air pollution (both household and ambient), open defecation, alcohol intake and smoking have negative influences, suggesting these factors are detrimental to health and longevity. The clustering of managed sanitation, managed drinking, and basic sanitation near Average Life Expectancy further emphasizes the critical role of health infrastructure in improving life expectancy outcomes.
